<script>
    EarthlapseUI.bind("loadedscreen", function (e) {
        if (e.mode !== "story") { return; }

        var $screen = $(".earthlapse-modes-screen.earthlapse-modes-story-container");
        var $explain = $screen.find(".earthlapse-stories-explain");

        function bindPrimaryNav() {
            // Button: Back to menu
            var $backToMenu = $screen.find(".earthlapse-modes-homebutton");
            $backToMenu.on("click", function(e) {
                e.preventDefault();
                EarthlapseUI.Stories.finishStory();
            });
        }

        function bindTimeline() {
            var $labelContainer = $(".earthlapse-stories-timeline-labels");
            var $line = $(".earthlapse-stories-timeline-line");

            var timelineLabels = [];
            var prevFrameNumber = -1;

            EarthlapseUI.bind("storytimeupdate", function (e) {
                if (timelineLabels.length === 0) { return; }

                // Animate timeline labels
                for (var i = 0; i < timelineLabels.length; i++) {
                    var frameNumber = timelineLabels[i].frameNumber;
                    if ((prevFrameNumber < frameNumber && frameNumber <= e.currentFrameNumber)
                     || (e.currentFrameNumber < prevFrameNumber && prevFrameNumber < frameNumber)
                     || (e.currentFrameNumber < prevFrameNumber && frameNumber <= e.currentFrameNumber)) {
                        timelineLabels[i].animReady = false;
                        timelineLabels[i].blurRequested = false;
                        timelineLabels[i].$label.addClass("hasfocus");
                    } else if (frameNumber !== e.currentFrameNumber) {
                        timelineLabels[i].blur();
                    }
                }
                prevFrameNumber = e.currentFrameNumber;

                // Update line length
                $line.css({
                    "right": (1 - e.currentTime / e.lastFrameTime) * 100 + "%",
                    "transition-duration": (1 / e.fps) + "s"
                });
            });

            EarthlapseUI.bind("storynewtimeline", function (e) {
                $labelContainer.empty();
                timelineLabels = [];
                prevFrameNumber = -1;

                var newLabel = function (frame) {
                    var $label = $("<span class=\"earthlapse-stories-timeline-labels-item\" />");

                    var timelineLabel = {
                        frameNumber: frame.frameNumber,
                        $label: $label,
                        animReady: true,
                        blurRequested: false,
                        blur: function () {
                            if (!timelineLabel.animReady) {
                                timelineLabel.blurRequested = true;
                                return;
                            }
                            $label.removeClass("hasfocus");
                            timelineLabel.blurRequested = false;
                        }
                    };
                    timelineLabels.push(timelineLabel);

                    $label.text(frame.frameId);
                    $label.bind("transitionend", function () {
                        timelineLabel.animReady = true;
                        if (timelineLabel.blurRequested) {
                            timelineLabel.blur();
                        }
                    });

                    return $label;
                };

                for (var i = 0; i < e.frames.length; i++) {
                    var $label = newLabel(e.frames[i]);
                    $labelContainer.append($label);

                    var width = $label.width();
                    $label.css({
                        marginLeft: -width/2,
                        marginRight: -width/2,
                        left: (e.frames[i].frameNumber / e.lastFrameNumber * 100) + "%",
                    });
                }
            });
        }

        function bindExplain() {
            var expireExplainContent = function () {
                var $oldContent = $explain.find(".earthlapse-stories-explain-content");
                $oldContent.addClass("earthlapse-stories-explain-content-exit");
                setTimeout(function () {
                    $oldContent.remove();
                }, 500);
            };

            var createExplainContent = function (e) {
                // Explain Text
                var $text = $("<div class=\"earthlapse-stories-explain-text\" />").text(e.text);

                // Explain Nav
                var $nav = $("<div class=\"earthlapse-stories-explain-nav\" />");
                if (!e.isFirstKeyframe) {
                    $nav.append("<button class=\"ui-button earthlapse-stories-explain-nav-button earthlapse-stories-explain-nav-back\">&larr; Back</button>");
                }
                if (!e.isLastKeyframe) {
                    $nav.append("<button class=\"ui-button earthlapse-stories-explain-nav-button earthlapse-stories-explain-nav-next\">Next &rarr;</button>");
                } else {
                    $nav.append("<button class=\"ui-button earthlapse-stories-explain-nav-button earthlapse-stories-explain-nav-next earthlapse-stories-explain-nav-done\">Finish</button>");
                }

                return $("<div class=\"earthlapse-stories-explain-content\" />").append($text, $nav);
            };

            // Explain Nav Buttons
            $explain.on("mousedown", ".earthlapse-stories-explain-nav-button", function (e) {
                $(this).addClass("hasfocus");
            }).on("mouseup", ".earthlapse-stories-explain-nav-button", function (e) {
                var $this = $(this);

                // If this button had focus, then we should execute an action
                if (!$this.hasClass("hasfocus")) { return; }
                e.preventDefault();

                var $this = $(this);
                $explain.removeClass("earthlapse-stories-explain-prev earthlapse-stories-explain-next");

                if ($this.hasClass("earthlapse-stories-explain-nav-done")) {
                    // End story
                    EarthlapseUI.Stories.finishStory();
                    return;
                }

                if ($this.hasClass("earthlapse-stories-explain-nav-back")) {
                    // Prepare content for exit
                    $explain.addClass("earthlapse-stories-explain-prev");

                    // Prev keyframe
                    EarthlapseUI.Stories.prevKeyframe();
                    return;
                }

                if ($this.hasClass("earthlapse-stories-explain-nav-next")) {
                    // Prepare content for exit
                    $explain.addClass("earthlapse-stories-explain-next");

                    // Next keyframe
                    EarthlapseUI.Stories.nextKeyframe();
                    return;
                }
            });

            EarthlapseUI.bind("storykeyframechanged", function (e) {
                // Exit old content
                expireExplainContent();

                // Enter new content
                $explain.append(createExplainContent(e).addClass("earthlapse-stories-explain-content-enter"));
            });

            EarthlapseUI.bind("storyenteredview", function (e) {
                $(".earthlapse-stories-explain-content").removeClass("earthlapse-stories-explain-content-enter");
            });

            EarthlapseUI.bind("storystarted", function () {
                // Reset UI
                $explain.removeClass("earthlapse-stories-explain-prev earthlapse-stories-explain-next");
                $explain.empty();
            });

            EarthlapseUI.bind("storyfinished", function () {
                // Exit content
                expireExplainContent();

                // Return to menu
                EarthlapseUI.Modes.changeModeTo("menu");
            });
        }

        bindPrimaryNav();
        bindTimeline();
        bindExplain();
    });

</script>
<div class="earthlapse-modes-screen">
    <button class="ui-button earthlapse-modes-homebutton">Menu</button>
    <div class="earthlapse-stories-explain"></div>
    <div class="earthlapse-stories-timeline">
        <div class="earthlapse-stories-timeline-wrap">
            <span class="earthlapse-stories-timeline-line"></span>
            <div class="earthlapse-stories-timeline-labels"></div>
        </div>
    </div>
</div>