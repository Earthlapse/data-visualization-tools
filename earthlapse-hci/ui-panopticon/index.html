<!DOCTYPE html>
<html>

<head>
    <title>Earth Timelapse Panopticon Screen</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <link href="../../timemachine/css/snaplapse.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/defaultUI.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/contextMap.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/scaleBar.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/customUI.css" rel="stylesheet" type="text/css" />
    <link href="../../timemachine/css/leaflet/leaflet.css" rel="stylesheet" type="text/css"/>
    <link href="../../js/customVideoTagControls/customVideoTagControls.css" rel="stylesheet" type="text/css"/>
    <link href="../../examples/webgl-timemachine/index.css" rel="stylesheet" type="text/css" />

    <script src="../../timemachine/js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/util.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
    <script src="../../timemachine/js/Math.uuid.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/mercator.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/scaleBar.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/contextMap.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/customUI.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
    <script src="../../timemachine/js/org/gigapan/timelapse/urlEncoder.js" type="text/javascript"></script>
    <script src="../../timemachine/template_includes.js" type="text/javascript"></script>
    <script src="../../timemachine/js/leaflet/leaflet.min.js" type="text/javascript" ></script>
    <script src="../../js/customVideoTagControls/customVideoTagControls.js" type="text/javascript"></script>
    <script src="../../../data/earthtime-annual-2015-v2/ajax_includes.js" type="text/javascript"></script>
    <script src="../../../../config.js" type="text/javascript"></script>

    <script src="../../examples/webgl-timemachine/TileIdx.js"></script>
    <script src="../../examples/webgl-timemachine/WebglVideoTile.js"></script>
    <script src="../../examples/webgl-timemachine/TileView.js"></script>
    <script src="../../examples/webgl-timemachine/Glb.js"></script>
    <script src="../../examples/webgl-timemachine/WebglTimeMachineLayer.js"></script>
    <script src="../../examples/webgl-timemachine/WebglMapLayer.js"></script>
    <script src="../../examples/webgl-timemachine/WebglVectorLayer.js"></script>
    <script src="../../examples/webgl-timemachine/WebglVectorLayer2.js"></script>
    <script src="../../examples/webgl-timemachine/WebglTimeMachinePerf.js"></script>
    <script src="../../examples/webgl-timemachine/WebGLVectorTile.js"></script>
    <script src="../../examples/webgl-timemachine/WebGLVectorTile2.js"></script>
    <script src="../../examples/webgl-timemachine/WebglMapTile.js"></script>
    <script src="../../examples/webgl-timemachine/WebglViirsTile.js"></script>
    <script src="../../examples/webgl-timemachine/WebglCoralTile.js"></script>
    <script src="../../examples/webgl-timemachine/WebglMapTile2.js"></script>
    <script src="../../examples/webgl-timemachine/WebglMapLayer2.js"></script>

    <script>
        "use strict";

        jQuery.support.cors = true;

        var previousWaypoint = {}, previousHimawariIdx, waypointViewChangeListener, hideWaypointListener;
        var forestAlertsTimeMachineLayer, forestAlertsNoOverlayTimeMachineLayer, landsatBaseMapLayer, timelapse, darkBaseMapLayer, lightBaseMapLayer, wdpaVectorLayer, mcrmVectorLayer, hansonMapLayer, hansonMapLayer2, viirsTile, coralBleachingTile, lightsAtNightMapLayer, crwTimemachineLayer, animatedHansenLayer, himawariTimemachineLayer, waterOccurrenceLayer, waterChangeLayer;

        var usgsWindTurbineLayer, solarInstallsLayer, drillingLayer;

        //// Config ////
        var EARTH_TIMELAPSE_CONFIG = EARTH_TIMELAPSE_CONFIG || {};

        var presentationSliderContent = EARTH_TIMELAPSE_CONFIG.waypointCollection || "http://timemachine.cmucreatelab.org/wiki/EarthEngineTourEditor#presentation=E5DDkDV0jvjsXrchC_Climate_DkDQhV1kUKXaiD_Fires%20at%20Night_DkDFWaNbFlEeqJ_Agricultural%20Fires_DkDASzGiNIcpvK_Agricultural%20Fires_DkDIAHUl1q2eqJ_Drilling%20Flares_DkDSx-Tmy5yMmK_Shale%20Oil%20Extraction_DkDRFMpUtEFyje_Eagle%20Downs%20Coal_DkDOHcDnYDBPjgB_Mountaintop%20Removal_DkDcYs5sY3cKrZ_Alberta%20Tar%20Sands_DkDIl59k8-Aurb_Shanghai_DkDIHBIjdC4j7f_Dubai_DkDIumflQzrMib_Dallas%20Fort-Worth_DkDWVyelV9qMjW_Dallas%20Fort-Worth%20_DkDIYWEnHy5MoJ_United%20States_DkDI8H8f-Cuc3C_Lights%20at%20Night_DkDI9F8k2euuzJ_East%20Asia_DkDPWPyXs9wR6gB_Rondonia_DkDPZ85XKYIShT_Rondonia_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDA8sGufoBFqe_Columbia%20Glacier_DkDNROTtit7GojB_Mendenhall%20Glacier_DkDFGq9mKcYi8VThe%20shrinking%20and%20drying%20up%20of%20the%20Lake%20Urmia_Lake%20Urmia_DkDOcGQprwpkmRThe%20shrinking%20of%20the%20Aral%20Sea%20destroys%20fishing%20industry%20and%20brings%20unemployment%20and%20public%20health%20problems_Aral%20Sea_DkDSq1joU5sk6gBThe%20expansion%20of%20irrigation%20systems%20near%20the%20Aral%20Sea_Aral%20Expansion_CkDWmblQtbBxuXBushfires%20in%20Australia%20are%20frequent%20during%20the%20hotter%20months%20of%20the%20year_Australia%20Bushfire_DkDblXvnAWJL2V_Bark%20Beetles_DkDPZ85XKYIShT_Rondonia_DkDPI2unYMQqrhB_Gansu%20Wind%20Farm_DkDPOxFm4qZJ2iB_Solar%20Star_DkDV0jvjsXrchC_Forest_DkDVWlolkXJOxe_Alabama_DkDVmSguE8quhS_Yakutsk_DkDVZNiW4_KhhS_Mozambique_DkDVdSqbMp9qlV_Indonesia_DkDVdhqUIJOShS_Paraguay_DkDV5NVdc5jalV_Cote%20D%E2%80%99Ivoire_DkDVzKwaoThslV_Kalimantan_DkDVjqJcYu9spY_Sarawak_DkDVxYQuwu2fhS_Russia%2FFinland_DkDV0jvjsXrchC_Water_DkDV9ofmUx7Jmd_Las%20Vegas_DkDFGq9mKcYi8VThe%20shrinking%20and%20drying%20up%20of%20the%20Lake%20Urmia_Lake%20Urmia_DkDOcGQprwpkmR_Aral%20Sea_DkDSq1joU5sk6gB_Aral%20Expansion_DkDSYrnkxOVh6c_Saudi%20Irrigation_DkDSVR-mLkAJ3c_Central%20Valley_DkDS4s-m9NHJ8gB_California%20Reservoir_BkDTiTRWWTmR6gBRiver%20meandering%20in%20the%20Amazon_Bolivia%20Meander_DkDK9ySWib2R2dThe%20abandonment%20of%20a%20river%20channel%20and%20the%20formation%20of%20a%20new%20river%20channel_Bolivia%20Avulsion_DkDTXCJXWOFUha_Brazil%20Reservoir_DkDT6ClYMn5SpN_Amazon%20Deforestation_DkDTypVi8CHpkd_Bangladesh_DkDT07enqs_t_gB_Fish%20Ponds%2C%20China_DkDV0jvjsXrchC_Coral%20Reef%20Watch_DkDV0jvjsXrchC_Resources_DkDVl59k8-Aurb_Shanghai_DkDVumflQzrMib_Dallas%20Fort-Worth_DkDVWWhlM5mMiiB_Barnett%20Shale_DkDWVyelV9qMjW_DFW%20Growth_DkDVYWEnHy5MoJ_United%20States_DkDV8H8f-Cuc3C_Lights%20at%20Night_DkDVsXXi870skf_Pearl%20River%20Delta_DkDQhV1kUKXaiD_Fires%20at%20Night_DkDIAHUl1q2eqJ_Drilling%20Flares_DkDSx-Tmy5yMmK_Shale%20Oil%20Extraction_DkDVbUxoD7ZLre_Wyoming%20Coal%20Mining_DkDOHcDnYDBPjgB_Mountaintop%20Removal_DkDV-99mHP-OgW_Mountaintop%20Removal_DkDVlMmn4Acs_iB_Hei%20Dai%20Gao%20Coal_DkDcYs5sY3cKrZ_Alberta%20Tar%20Sands_DkDVNViXQeyQjgB_Peru%20Mining_DkDVEuOaR5YwojB_Grasberg%20Mine_DkDVOnDa0YXw6d_Grasberg%20Tailings_DkDOcGQprwpkmR_Aral%20Sea_DkDOYrnkxOVh6c_Saudi%20Irrigation_DkDPWPyXs9wR6gB_Rondonia_DkDPZ85XKYIShT_Rondonia_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDPidYYbN4SwM_Amazon%20Rain%20Forest_DkDPNEabGoEs-N_Indonesia%20Forests_DkDWOpqWSEFK2Q_Sumatra%20Fires_DkDPRG9ln6qOtN_Forestry%20SE%20US_DkDWWnfme-zqiiB_Longyangxia%20Solar_DkDPOxFm4qZJ2iB_Solar%20Star_DkDPjqQmuXJJojB_Topaz%20Solar%20Farm_DkDPKtwiQVVmojB_Charanka%20Solar%20Park_DkDPGUUmWP2JojB_Ivanpah%20Solar%20Power_DkDP22pmX2kaojB_Valle%20Solar%20Power_DkDPI2unYMQqrhB_Gansu%20Wind%20Farm_DkDPEuJmc6aJojB_Alta%20Wind%20Farm_DkDPD7CnLTtMiK_US%20Wind_DkDPD7CnLTtMiK_US%20Photovoltaic_DkDV0jvjsXrchC_Industrialization_DkDVlsznvjQPkgB_Pittsburgh_DkDWksznwjQP_Z_Pittsburgh_DkDVLjfdNa_b5c_Lagos_DkDVLjfdNa_b5c_Lagos_DkDP4t6mgw0u7c_Seoul_DkDP4t6mgw0u7c_Seoul_DkDQ5wYitp3subShenzhen%20bay%2C%20growth%20of%20land%20use%20into%20bay%2E_Shenzhen_DkDQrnpWLjJUya_Brasilia_DkDQoLbXOXaTsV_Brasilia_DkDQ5YWph63cxf_Milano_DkDQSHLrsBhcigB_Duisburg_DkDQENjTEnwf2d_Pretoria_DkDAFpEbiqFhmjB_Nairobi_DkDAZdNelWYhojB_Addis%20Ababa_DkDAGq9mKcYi8V_Lake%20Urmia_DkDAGyOdZ5mcnC_Coral%20Reefs_DkDAHBYiAv1s9a_Shenzhen_DkDWFqgBAAAA1M_Himawari-8_DkDWOpqWSEFK2Q_Sumatra%20Fires_DkDWA-fScC5OtR_Sinabung%20Volcano_DkDWFqgBAAAA1M_Clear%20Beijing_DkDWFqgBAAAA1M_Hazy%20Beijing_DkDWFqgBAAAA1M_Hazier%20Beijing_DkDWFqgBAAAA1M_Melting%20Snow_DkDWtEyBMH2b3N_Ice%20Floes_DkDWqpyBvNmagT_Iceberg%20calving_BAWFqgBAAAA1M_Typhoon%20In-Fa_Untitled_B";
        var showEVA = !!EARTH_TIMELAPSE_CONFIG.showEVA;
        var isHyperwall = !!EARTH_TIMELAPSE_CONFIG.isHyperwall;
        var useGoogleMaps = !!EARTH_TIMELAPSE_CONFIG.useGoogleMaps;
        var useGoogleSearch = (typeof(EARTH_TIMELAPSE_CONFIG.useGoogleSearch) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.useGoogleSearch;
        var enableAutoMode = !!EARTH_TIMELAPSE_CONFIG.enableAutoMode;
        var screenTimeoutInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.screenTimeoutInMilliseconds) || 8 * 60 * 1000;
        var waypointDelayInMilliseconds = parseInt(EARTH_TIMELAPSE_CONFIG.waypointDelayInMilliseconds) || 1 * 15 * 1000;
        var defaultPlaybackSpeed = parseFloat(EARTH_TIMELAPSE_CONFIG.defaultPlaybackSpeed) || 0.5;
        var enableLetterboxMode = (typeof(EARTH_TIMELAPSE_CONFIG.enableLetterboxMode) == "undefined") ? false : !!EARTH_TIMELAPSE_CONFIG.enableLetterboxMode;
        var useFaderShader = (typeof(EARTH_TIMELAPSE_CONFIG.useFaderShader) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.useFaderShader;
        var enableWaypointText = (typeof(EARTH_TIMELAPSE_CONFIG.enableWaypointText) == "undefined") ? true : !!EARTH_TIMELAPSE_CONFIG.enableWaypointText;
        var enableRecordingMode = (typeof(EARTH_TIMELAPSE_CONFIG.enableRecordingMode) == "undefined") ? false : !!EARTH_TIMELAPSE_CONFIG.enableRecordingMode;

        var landsatMaxScale = 1.25;
        var himawariMaxScale = 0.02;
        var isAutoModeRunning = false;
        var UTIL = org.gigapan.Util;

        //// Context Map Tiles ////
        var osmDefaultUrl = "../../../data/openstreetmap/default/";

        //// Video Tiles
        var landsatUrl = "../../../data/earthtime-annual-2015-v2/1068x600";
        // Using "https" will casue the thumbnail loading from the server to fail
        //var landsatUrl = "http://earthengine.google.org/timelapse/data/20130507";
        var crwTimemachineUrl = "../../../data/coral/coralreefwatch-2.timemachine/crf20-22fps-1424x800";
        var himawariTimemachineUrl = "../../../data/himawari8/himawari8-nov-2015.timemachine/crf26-12fps-1424x800";
        var forestAlertsTimeMachineUrl = "../../../data/global-forest-alerts/ForestAlarms2015v5/1068x600";
        var forestAlertsNoOverlayTimeMachineUrl = "../../../data/global-forest-alerts/ForestAlarmsNoOverlay2015v5/1068x600";

        //// Map Tiles ////
        // OpenStreetMap/CartoDB
        var osmLightRetinaUrl = "../../../data/openstreetmap/light_all_retina/{default}/{z}/{x}/{y}.png";
        var osmDarkRetinaUrl = "../../../data/openstreetmap/dark_all_retina/{default}/{z}/{x}/{y}.png";
        // Global Forest Change (Matt Hansen)
        var gfcTransUrl = "../../../data/global-forest-change/loss_year_transparent/{default}/{z}/{x}/{y}.png";
        var gfcLossGainUrl = "../../../data/global-forest-change/loss_tree_gain/{default}/{z}/{x}/{y}.png";
        // Google Maps non-retina
        var googleMapsDefaultUrl = "https://mts0.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0";
        var googleMapsDarkStyleUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0";
        // Google Maps retina
        var googleMapsDefaultRetinaUrl = "https://mts1.googleapis.com/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i323305239!3m9!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0!5m1!5f2";
        var googleMapsDarkStyleRetinaUrl = "https://mts0.googleapis.com/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i323305239!3m14!2sen-US!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcC5oOiMwMDAwYjB8cC5pbDp0cnVlfHAuczotMzAscy50OjJ8cC52Om9mZg!4e0!5m1!5f2";
        // Lights At Night
        var lightsAtNightUrl = "../../../data/lights-at-night/{default}/{z}/{x}/{y}.png";
        // Water Occurrence
        var waterOccurrenceUrl = "../../../data/water/occurrence-2015/{default}/{z}/{x}/{y}.png";
        // Water Change
        var waterChangeUrl = "../../../data/water/change-2015/{default}/{z}/{x}/{y}.png";

        //// Vector Tiles ////
        var wdpaUrl = "../../../data/wdpaline-year";
        var mcrmUrl = "../../../data/coral/mcrm-lines-wrapdateline";
        var viirsUrl = '../../../data/viirs/createlab-viirs-uncorrected-20140314-20150403.bin';
        var coralBleachingUrl = "../../../data/coral/bleaching_reports_4km_81-10.bin";

        var usgsWindTurbineUrl = "../../../data/energy/wind-installs-usgs";
        var solarInstallsUrl = "../../../data/energy/solar-installs";
        var drillingUrl = "../../../data/energy/drilling";

        var animatedHansenUrls = [gfcTransUrl, gfcLossGainUrl];

        var visibleBaseMapLayer = "light";
        var previousVisibleBaseMapLayer = visibleBaseMapLayer;

        function init() {
            var settings = {
                loopDwell: { startDwell:1.5, endDwell:1.5 },
                playbackSpeed: defaultPlaybackSpeed,
                viewerType: "webgl",
                url: landsatUrl,
                enablePresentationSlider: enableRecordingMode ? false : true,
                enableEditor: enableRecordingMode ? true : false,
                showEditorOnLoad: enableRecordingMode ? true : false,
                thumbnailServerRootTileUrl: "http://earthengine.google.org/timelapse/data/20130507",
                showFullScreenBtn: false,
                presentationSliderSettings: enableRecordingMode ? {} : {
                    onLoadAnimation: "none",
                    playAfterAnimation: false,
                    initialWaypointIndex: 0,
                    doAutoMode: enableAutoMode,
                    showAnnotations: false,
                    screenIdleTime: screenTimeoutInMilliseconds,
                    waypointDelayTime: waypointDelayInMilliseconds,
                    height: 94
                },
                useTouchFriendlyUI: isHyperwall,
                datasetType: "landsat",
                playOnLoad: false, // enableRecordingMode ? false : true,
                mediaType: ".mp4",
                onTimeMachinePlayerReady: function(viewerDivId) {},
                scaleBarOptions: {
                    scaleBarDiv: "scaleBar1"
                },
                contextMapOptions: {
                    contextMapDiv: "contextMap1",
                    tileType: useGoogleMaps ? "Google" : "OpenStreetMap",
                    tileUrl: osmDefaultUrl,
                    geometry: {
                        width: 270,
                        height: 200
                    }
                },
                isGoogleAnalyticEventTrackingEnabled: false
            };

            timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", settings);
            onTimeMachinePlayerReady();

            perf = new WebglTimeMachinePerf(document.getElementById('stats'), timelapse);
            $('#stats').hide();
        }

        $(init);
    </script>

    <script src="../../js/TimeMachineCanvasLayer.js" type="text/javascript"></script>

    <script type="text/javascript" src="../../js/base.js"></script>
    <script type="text/javascript" src="../../js/io.js"></script>
    <script type="text/javascript" src="../../js/utils.js"></script>

    <script>
        // BEGIN WebGL vars
        var canvasLayer;
        var gl, glb;

        var showWdpaLayer = false;
        var showMcrmLayer = false;
        var showHansonLayer = false;
        var showHansonLayer2 = false;
        var showViirsLayer = false;
        var showCoralBleachingLayer = false;
        var showLightsAtNightLayer = false;
        var showCrwTimemachineLayer = false;
        var showAnimatedHansenLayer = false;
        var showHimawariTimeMachineLayer = false;
        var showForestAlertsTimeMachineLayer = false;
        var showForestAlertsNoOverlayTimeMachineLayer = false;
        var showWaterOccurrenceLayer = false;
        var showWaterChangeLayer = false;

        var showUsgsWindTurbineLayer = false;
        var showSolarInstallsLayer = false;
        var showDrillingLayer = false;

        var tileViewVisibility = {
            videoTile: true,
            vectorTile: false
        };

        function onTimeMachinePlayerReady() {
            // initialize the canvasLayer
            var timeMachineCanvasLayerOptions = {
                timelapse: timelapse,
                resizeHandler: resize,
                animate: true,
                updateHandler: update,
                resolutionScale: window.devicePixelRatio || 1
            };
            canvasLayer = new TimeMachineCanvasLayer(timeMachineCanvasLayerOptions);

            // initialize WebGL
            gl = canvasLayer.canvas.getContext('experimental-webgl');
            glb = new Glb(gl);

            //// Time Machine layers

            // Landsat
            var defaultTimeMachineLayerOptions = {
                mediaType: ".mp4",
                numFrames: 32,
                fps: 10
            };
            landsatBaseMapLayer = new WebglTimeMachineLayer(glb, canvasLayer, landsatUrl, defaultTimeMachineLayerOptions);

            // Coral Bleaching Alerts
            var crwTimemacineLayerOptions = {
                mediaType: ".mp4",
                numFrames: 904,
                fps: 22,
                video_width: 1424,
                video_height: 800,
                width: 7200,
                height: 7200,
                greenScreen: true
            };
            crwTimemachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, crwTimemachineUrl, crwTimemacineLayerOptions);

            // Himawari-8
            var himawariTimeMachineLayerOptions = {
                mediaType: ".mp4",
                numFrames: 4249,
                fps: 12,
                nLevels: 4,
                video_width: 1424,
                video_height: 800,
                width: 11000,
                height: 11000
            };
            himawariTimemachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, himawariTimemachineUrl, himawariTimeMachineLayerOptions);

            // Forest Alerts
            var forestAlertsTimeMachineLayerOptions = {
                mediaType: ".mp4",
                numFrames: 183,
                fps: 10,
                nLevels: 11,
                video_width: 1424,
                video_height: 800,
                width: 750836,
                height: 156136
            };
            forestAlertsTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, forestAlertsTimeMachineUrl, forestAlertsTimeMachineLayerOptions);
            // Forest Alerts No Overlay
            forestAlertsNoOverlayTimeMachineLayer = new WebglTimeMachineLayer(glb, canvasLayer, forestAlertsNoOverlayTimeMachineUrl, forestAlertsTimeMachineLayerOptions);



            //// Raster map layers
            var defaultMapLayerOptions = {
                nLevels: 12,
                tileWidth: 256,
                tileHeight: 256
            };
            var defaultBaseMapLayerOptions = {
                nLevels: 11,
                tileWidth: 256,
                tileHeight: 256
            };
            var retinaMapLayerOptions = {
                nLevels: 11,
                tileWidth: 512,
                tileHeight: 512
            };
            var lightsAtNightMapLayerOptions = {
                nLevels: 8,
                tileWidth: 256,
                tileHeight: 256
            };

            var lightTileUrl = useGoogleMaps ? googleMapsDefaultRetinaUrl : osmLightRetinaUrl;
            var darkTileUrl = useGoogleMaps ? googleMapsDarkStyleRetinaUrl : osmDarkRetinaUrl;

            var mapBaseLayerOptions = isHyperwall ? retinaMapLayerOptions : defaultBaseMapLayerOptions;

            lightBaseMapLayer = new WebglMapLayer(glb, canvasLayer, lightTileUrl, mapBaseLayerOptions);
            darkBaseMapLayer = new WebglMapLayer(glb, canvasLayer, darkTileUrl, mapBaseLayerOptions);
            hansonMapLayer = new WebglMapLayer(glb, canvasLayer, gfcTransUrl, defaultMapLayerOptions);
            hansonMapLayer2 = new WebglMapLayer(glb, canvasLayer, gfcLossGainUrl, defaultMapLayerOptions);
            wdpaVectorLayer = new WebglVectorLayer(glb, canvasLayer, wdpaUrl, defaultMapLayerOptions);
            mcrmVectorLayer = new WebglVectorLayer2(glb, canvasLayer, mcrmUrl, defaultBaseMapLayerOptions);
            lightsAtNightMapLayer = new WebglMapLayer(glb, canvasLayer, lightsAtNightUrl, lightsAtNightMapLayerOptions);
            waterOccurrenceLayer = new WebglMapLayer(glb, canvasLayer, waterOccurrenceUrl, defaultBaseMapLayerOptions);
            waterChangeLayer = new WebglMapLayer(glb, canvasLayer, waterChangeUrl, defaultBaseMapLayerOptions);
        }
    </script>

    <script>
        function initLayerToggleUI() {
            $(window).resize(function () {
                var width = $(window).width();
                var height = $(window).height();
                var scale = Math.min(1, Math.min((width * 1.8) / 1920, (height * 1.28) / 1200));
                if (!enableLetterboxMode) {
                    $('.vector-layers').css({'transform-origin': 'bottom right'});
                    $('.vector-layers').css({'transform': 'scale(' + scale + ')'});
                }
                if (!isHyperwall && enableLetterboxMode) {
                    scale = Math.min(1, Math.min(width / 1920, height / 1080));
                    $('.map-layer-div').css({'transform-origin': 'center right', 'transform': 'scale(' + scale + ')'});
                    $('.base-map-div').css({'transform-origin': 'center left', 'transform': 'scale(' + scale + ')'});
                    $('.extras-selector-div, .location_search_div').css({'transform-origin': 'center left', 'transform': 'scale(' + '0.9' + ')'});
                }
            });
        }
    </script>

    <script>
        var perf;
        var maximumUpdateTime = 100; // milliseconds
        var startOfRedraw;

        function redrawTakingTooLong() {
            return performance.now() - startOfRedraw > maximumUpdateTime;
        }

        function resize() {
            var width = canvasLayer.canvas.width;
            var height = canvasLayer.canvas.height;

            gl.viewport(0, 0, width, height);
        }

        //var firstDrawTime = null;
        //var lastFrameTime = null

        // Draws to canvas.
        // Called by TimeMachineCanavasLayer during animation and/or view changes
        function update() {

            /*var frameTime = performance.now();
            startOfRedraw = frameTime;

            if (lastFrameTime != null) {
            var duration = frameTime - lastFrameTime;
            }
            lastFrameTime = frameTime;

            //stats.begin();
            if (WebglVideoTile.verbose) {
            function r2(x) {
                return Math.round(x * 100) / 100;
            }
            console.log(r2(performance.now()) + ' update start --------------------------------------------------');
            }*/

            //if (performance.now() - firstDrawTime < 1 * 5000) {
            //  WebglVideoTile.verbose = true;
            //} else {
            //  if (WebglVideoTile.verbose) {
            //    WebglVideoTile.verbose = false;
            //    console.log(WebglVideoTile.stats());
            //  }
            //}

            gl.clear(gl.COLOR_BUFFER_BIT);

            // Draw himawari
            if (showHimawariTimeMachineLayer) {
            var himawariView = timelapse.getView();
            var timelapse2map = himawariTimemachineLayer.getWidth() / landsatBaseMapLayer.getWidth();
            himawariView.x *= timelapse2map;
            himawariView.y *= timelapse2map;
            himawariView.scale /= timelapse2map;
            himawariTimemachineLayer.draw(himawariView, tileViewVisibility);
            } else {

            // Draw lightsAtNightMapLayer
            if (showLightsAtNightLayer) {
                // Construct view for lightsAtNightMapLayer
                var lightsAtNightLayerView = timelapse.getView();
                var timelapse2map = lightsAtNightMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
                lightsAtNightLayerView.x *= timelapse2map;
                lightsAtNightLayerView.y *= timelapse2map;
                lightsAtNightLayerView.scale /= timelapse2map;

                lightsAtNightMapLayer.draw(lightsAtNightLayerView);
            }

            // Draw base layer
            else if (visibleBaseMapLayer == "landsat") {
                landsatBaseMapLayer.draw(timelapse.getView(), tileViewVisibility);
            } else if (visibleBaseMapLayer == "light") {
                // Construct view for lightBaseMapLayer
                var lightBaseMapView = timelapse.getView();
                var timelapse2map = lightBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
                lightBaseMapView.x *= timelapse2map;
                lightBaseMapView.y *= timelapse2map;
                lightBaseMapView.scale /= timelapse2map;

                landsatBaseMapLayer.draw(timelapse.getView(), tileViewVisibility);
                lightBaseMapLayer.draw(lightBaseMapView);
            } else if (visibleBaseMapLayer == "dark") {
                // Construct view for darkBaseMapLayer
                var darkBaseMapView = timelapse.getView();
                var timelapse2map = darkBaseMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
                darkBaseMapView.x *= timelapse2map;
                darkBaseMapView.y *= timelapse2map;
                darkBaseMapView.scale /= timelapse2map;

                darkBaseMapLayer.draw(darkBaseMapView);
            }

            // Layers to draw above the base layer

            if (showCrwTimemachineLayer) {
                var crwView = timelapse.getView();
                var timelapse2map = crwTimemachineLayer.getWidth() / landsatBaseMapLayer.getWidth();
                crwView.x *= timelapse2map;
                crwView.y *= timelapse2map;
                crwView.scale /= timelapse2map;
                crwTimemachineLayer.draw(crwView, tileViewVisibility);
            }

            // Draw hansonMapLayer (Forest change transparent)
            if (showHansonLayer) {
                // Construct view for hansonMapLayer
                var hansonMapLayerView = timelapse.getView();
                var timelapse2map = hansonMapLayer.getWidth() / landsatBaseMapLayer.getWidth();
                hansonMapLayerView.x *= timelapse2map;
                hansonMapLayerView.y *= timelapse2map;
                hansonMapLayerView.scale /= timelapse2map;

                hansonMapLayer.draw(hansonMapLayerView);
            }

            // Draw hansonMapLayer2 (Forest Loss/Gain)
            if (showHansonLayer2) {
                // Construct view for hansonMapLayer2
                var hansonMapLayerView2 = timelapse.getView();
                var timelapse2map = hansonMapLayer2.getWidth() / landsatBaseMapLayer.getWidth();
                hansonMapLayerView2.x *= timelapse2map;
                hansonMapLayerView2.y *= timelapse2map;
                hansonMapLayerView2.scale /= timelapse2map;

                hansonMapLayer2.draw(hansonMapLayerView2);
            }

            // Draw water occurrence
            if (showWaterOccurrenceLayer) {
                // Construct view for waterOccurrenceLayer
                var waterOccurrenceView = timelapse.getView();
                var timelapse2map = waterOccurrenceLayer.getWidth() / landsatBaseMapLayer.getWidth();
                waterOccurrenceView.x *= timelapse2map;
                waterOccurrenceView.y *= timelapse2map;
                waterOccurrenceView.scale /= timelapse2map;

                waterOccurrenceLayer.draw(waterOccurrenceView);
            }

            // Draw water change
            if (showWaterChangeLayer) {
                // Construct view for waterChangeLayer
                var waterChangeView = timelapse.getView();
                var timelapse2map = waterChangeLayer.getWidth() / landsatBaseMapLayer.getWidth();
                waterChangeView.x *= timelapse2map;
                waterChangeView.y *= timelapse2map;
                waterChangeView.scale /= timelapse2map;

                waterChangeLayer.draw(waterChangeView);
            }

            // Draw Animated Hansen Layer
            if (showAnimatedHansenLayer) {
                // Construct view for hansonMapLayer
                var animatedHansenLayerView = timelapse.getView();
                var timelapse2map = animatedHansenLayer.getWidth() / landsatBaseMapLayer.getWidth();
                animatedHansenLayerView.x *= timelapse2map;
                animatedHansenLayerView.y *= timelapse2map;
                animatedHansenLayerView.scale /= timelapse2map;


                var ratio = 0;

                var captureTimes = timelapse.getCaptureTimes();
                var offset = captureTimes.indexOf("2000");
                var fps = timelapse.getFps();
                if (offset > -1) {
                var currentTime = Math.max(0,timelapse.getCurrentTime() - offset/fps);
                ratio = currentTime / ((captureTimes.length - offset - 1)/fps);
                ratio = Math.min(1, currentTime);
                }
                animatedHansenLayerView.alpha = ratio;

                animatedHansenLayer.draw(animatedHansenLayerView);
            }

            if (showMcrmLayer) {
                var mcrmLayerView = timelapse.getView();
                var timelapse2map = mcrmVectorLayer.getWidth() / landsatBaseMapLayer.getWidth();
                mcrmLayerView.x *= timelapse2map;
                mcrmLayerView.y *= timelapse2map;
                mcrmLayerView.scale /= timelapse2map;

                mcrmVectorLayer.draw(mcrmLayerView);
            }


            // VIIRS layer
            if (showViirsLayer) {
                var viirsView = timelapse.getView();
                viirsView.zoom = timelapse.getCurrentZoom();
                var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
                var times = timelapse.getCaptureTimes();
                var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
                var currentDate = ratio*range + new Date(times[0]).getTime();
                viirsView.currentDate = currentDate;
                viirsTile.draw(viirsView);
            }

            if (showCoralBleachingLayer) {
                var viirsView = timelapse.getView();
                viirsView.zoom = timelapse.getCurrentZoom();
                var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
                var times = timelapse.getCaptureTimes();
                var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
                var currentDate = ratio*range + new Date(times[0]).getTime();
                viirsView.currentDate = currentDate;
                coralBleachingTile.draw(viirsView);
            }

            if (showUsgsWindTurbineLayer) {
                var usgsWindTurbineLayerView = timelapse.getView();
                var timelapse2map = usgsWindTurbineLayer.getWidth() / landsatBaseMapLayer.getWidth();
                usgsWindTurbineLayerView.x *= timelapse2map;
                usgsWindTurbineLayerView.y *= timelapse2map;
                usgsWindTurbineLayerView.scale /= timelapse2map;
                usgsWindTurbineLayerView.zoom = timelapse.getCurrentZoom();
                var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
                var times = timelapse.getCaptureTimes();
                var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
                var currentDate = ratio*range + new Date(times[0]).getTime();
                usgsWindTurbineLayerView.currentTime = currentDate;
                usgsWindTurbineLayerView.color = [0.1, 0.5, 0.1, 1.0];
                usgsWindTurbineLayer.draw(usgsWindTurbineLayerView);
            }

            if (showSolarInstallsLayer) {
                var solarInstallsLayerView = timelapse.getView();
                var timelapse2map = usgsWindTurbineLayer.getWidth() / landsatBaseMapLayer.getWidth();
                solarInstallsLayerView.x *= timelapse2map;
                solarInstallsLayerView.y *= timelapse2map;
                solarInstallsLayerView.scale /= timelapse2map;
                solarInstallsLayerView.zoom = timelapse.getCurrentZoom();
                var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
                var times = timelapse.getCaptureTimes();
                var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
                var currentDate = ratio*range + new Date(times[0]).getTime();
                solarInstallsLayerView.currentTime = currentDate;
                solarInstallsLayer.draw(solarInstallsLayerView);
            }

            if (showDrillingLayer) {
                var drillingLayerView = timelapse.getView();
                var timelapse2map = drillingLayer.getWidth() / landsatBaseMapLayer.getWidth();
                drillingLayerView.x *= timelapse2map;
                drillingLayerView.y *= timelapse2map;
                drillingLayerView.scale /= timelapse2map;
                drillingLayerView.zoom = timelapse.getCurrentZoom();
                var ratio = timelapse.getCurrentTime() / (timelapse.getNumFrames() / timelapse.getFps());
                var times = timelapse.getCaptureTimes();
                var range = new Date(times[times.length - 1]).getTime() - new Date(times[0]).getTime();
                var currentDate = ratio*range + new Date(times[0]).getTime();
                drillingLayerView.currentTime = currentDate;
                drillingLayerView.color = [0.82, 0.22, 0.07, 1.0];
                drillingLayer.draw(drillingLayerView);
            }

            // Draw forest alerts no overlay
            if (showForestAlertsNoOverlayTimeMachineLayer) {
                var forestAlertsNoOverlayView = timelapse.getView();
                var timelapse2map = forestAlertsNoOverlayTimeMachineLayer.getWidth() / landsatBaseMapLayer.getWidth();

                var p = timelapse.getProjection();
                var offest = p.latlngToPoint({"lat":5.506709319555738, "lng":-82.5513118548623});

                forestAlertsNoOverlayView.x -= offest.x;
                forestAlertsNoOverlayView.y -= offest.y;
                forestAlertsNoOverlayTimeMachineLayer.draw(forestAlertsNoOverlayView, tileViewVisibility);
            }

            // Draw forest alerts
            if (showForestAlertsTimeMachineLayer) {
                var forestAlertsView = timelapse.getView();
                var timelapse2map = forestAlertsTimeMachineLayer.getWidth() / landsatBaseMapLayer.getWidth();

                var p = timelapse.getProjection();
                var offest = p.latlngToPoint({"lat":5.506709319555738, "lng":-82.5513118548623});

                forestAlertsView.x -= offest.x;
                forestAlertsView.y -= offest.y;
                forestAlertsTimeMachineLayer.draw(forestAlertsView, tileViewVisibility);
            }

            // Draw wdpaLayer
            if (showWdpaLayer)
                wdpaVectorLayer.draw(timelapse.getView());

            }

            //stats.end();
        }
    </script>
</head>

<body>
    <div id="timeMachine"></div>
    <canvas id="stats" style="position:absolute; top:0px; right:0px; z-index:100" width=1000 height=153></canvas>
</body>

</html>